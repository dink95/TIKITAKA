<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>TIKITAKA &ndash; 상품등록 </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mukta:300,400,700">
    <link rel="stylesheet" href="../fonts/icomoon/style.css">

    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/magnific-popup.css">
    <link rel="stylesheet" href="../css/jquery-ui.css">
    <link rel="stylesheet" href="../css/owl.carousel.min.css">
    <link rel="stylesheet" href="../css/owl.theme.default.min.css">
    <link rel="stylesheet" href="../css/aos.css">
    <link rel="stylesheet" href="../css/style.css">


</head>

<body>


<div class="site-wrap">
    <header class="site-navbar" role="banner">
        <!--replace 헤더-->
        <div class="site-navbar-top" th:replace="common::header(product_list)">
        </div>
        <!------------->
        <!--replace-login-------------------------------->

        <nav class="site-navigation text-right text-md-center" role="navigation"
             th:replace="common::menu(product_list)">
        </nav>
        <!----------------------------------------------------------->
    </header>

    <!--모바일 검색창-->
    <div th:replace="common::mobile_search(product_list)"></div>


    <!--replace logo-login-->
    <div class="bg-light py-3" th:fragment="logo(logo)">
        <div class="container">
            <div class="row">
                <div class="col-md-12 mb-0"><a href="/"> 카테고리 </a></span>
                    <span class="text-black" id="queryTextCatNm" ></span>
                    <span id="detailCatNm"></span>

                    <!--search box div-->
                    <div id="form" class="site-block-top-search input-search" style="margin:0 10px; width: 20%; display: inline-block; min-width: 220px;">
                        <input type="hidden" id="selectedMain" value="">
                        <input type="hidden" id="selectedDetail" value="">
                        <input type="hidden" id="selectCat" value="">
                        <input type="text" class="form-control border-0 input-search" placeholder="Search"
                               id="prodNm" style="height: 30px;">
                        <span type="submit" class="icon icon-search2" ></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!------------------------->
    <div style="padding-top:10px">
        <div class="container">
            <h1 class="text-black" id="queryTextProdNm" ></h1>
            <!--검색바 중간 삽입-->
            <div class="search-bar-container">
                <!------------------------------------------------------------------------------->
                <div class="gridContainer">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 모바일 메뉴-->
<div th:replace="common::mobile(product_list)"></div>

<style>
    .form-control.border-0.input-search{
        border-style: none;
    }
    /*이미지리스트 css*/
    .block-4-image {
        margin: 0;
    }

    .block-4-text {
        font-size: 16px;
        color: #000;
    }

    .img-fluid {
        width: 100%;
        height: 193.53px;
    }

    .block-4-text {
        padding: 10px 0;
    }

    .ItemName {
        margin: 0 20px 20px 20px;
        display: flex;
        justify-content: flex-start;
    }
    .ItemName>a {
        text-align: left;
    }
    p {
        margin: 0;
    }

    span {
        font-size: 14px;
        color: #000;
    }

    .priceContent {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 20px 10px 0 20px;
    }
    .gridItem{
        max-width: 225px;
    }

    /*****************/
</style>
<script src="../js/jquery-3.3.1.min.js"></script>
<script src="../js/jquery-ui.js"></script>
<script src="../js/popper.min.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script src="../js/owl.carousel.min.js"></script>
<script src="../js/jquery.magnific-popup.min.js"></script>
<script src="../js/aos.js"></script>
<script src="../js/main.js"></script>
<script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>
<script>

    $('#form').keypress(function(e){
        if(e.keyCode ===13){
            getProductList();
        }
    });

    /*카테고리 이름*/
    function getCategory() {

        param = {
            catNo: searchParam('catNo'),
        }

        $.ajax({
            url: '/category/get',
            data: param,
            type: 'post',
            dataType: 'json'
        }).done(function (data) {
            console.log("@@data.categoryDTO", data.categoryDTO);
            if(data.categoryDTO.catNo % 10 != 0)
            {
                $('#detailCatNm').text(" " + ">" + " " + data.categoryDTO.catNm);
                $('#selectedDetail').val(data.categoryDTO.catNo);
                console.log(Math.floor(data.categoryDTO.catNo / 10) * 10);
            }
            Mainparam = {
                catNo: Math.floor(data.categoryDTO.catNo / 10) * 10,
            }

            $.ajax({
                url: '/category/get',
                data: Mainparam,
                type: 'post',
                dataType: 'json'
            }).done(function (data) {
                $('#queryTextCatNm').text(" " + ">" +" " + data.categoryDTO.catNm);
                if( $('#selectedDetail').val() == '') {
                    $('#selectCat').val(data.categoryDTO.catNo);
                    $('#detailCatNm').text(" " + ">" + " " + '전체');
                }else{
                    $('#selectCat').val( $('#selectedDetail').val());
                }
            }).fail(function (data, textStatus, errorThrown) {
                console.log(textStatus);


            });

        }).fail(function (data, textStatus, errorThrown) {
            console.log(textStatus);


        });
    }

    function searchParam(key) {
        return new URLSearchParams(location.search).get(key);
    };
    if(searchParam('prodNm')){
        $('#queryTextCatNm').text(" "+ ">" + " "+ "전체");
        $('#queryTextProdNm').text('"' + searchParam('prodNm') + '"' + "검색결과" );
    }

    function getProdNmQueryList(){
        param = {
            prodNm:searchParam('prodNm'),
        }
        $.ajax({
            url: '/product/list.prodNm',
            data: param,
            type: 'post',
            dataType: 'json'
        }).done(function (data) {
            if(data.dataQueryList.length == 0){
                $('#queryTextProdNm').text('"' + searchParam('prodNm')+ '"' + ' ' + "검색결과가 없습니다.");
            }else {
                drawPrdList(data);
                console.log(data);
            }
        }).fail(function (data, textStatus, errorThrown) {
            console.log(textStatus);
        });
    }

    function getCatQueryList(){

        param = {
            catNo:searchParam('catNo'),
        }
        $.ajax({
            url: '/product/list.category',
            data: param,
            type: 'post',
            dataType: 'json'
        }).done(function (data) {
            drawPrdList(data);
            console.log(data);
        }).fail(function (data, textStatus, errorThrown) {
            console.log(textStatus);
        });
    }

    function getProductList() {
        param = {
            prodNm:$('#prodNm').val(),
            catNo:$('#selectCat').val()
        }
        $.ajax({
            url: '/product/list.query',
            data: param,
            type: 'post',
            dataType: 'json'
        }).done(function (data) {
            if(data.dataQueryList.length == 0){
                $('#queryTextProdNm').text('"' + $('#prodNm').val() + '"' + "검색결과가 없습니다.");
            }else {
                $('#queryTextProdNm').text('"' + $('#prodNm').val() + '"' + "검색결과");
                drawPrdList(data);
                console.log(data);
            }
        }).fail(function (data, textStatus, errorThrown) {
            console.log(textStatus);
        });
    }

    function drawPrdList(data) {
        console.log("@query data",data);
        if (typeof data.dataQueryList!== 'undefined' &&  data.dataQueryList.length > 0) {
            var container = $('.gridContainer');
            container.empty();
            var contents = '';
            var imgPath = '';
            $.each( data.dataQueryList, function (index, obj) {
                console.log("@query data prodNo",obj.prodNo);
                // 매번 컨텐츠가 달라야하니 초기화
                contents = '';
                var wday=timeForToday(obj.wday);
                //이미지경로를 미리 만들어놓는다.
                imgPath = '/istatic/images/' + obj.prodNo + '/1.jpg';

                //상품 하나 html
                contents += '<div class="gridItem">';
                contents += '    <div class="item">';
                contents += '       <div class="block-4 text-center">';
                contents += '          <a href="#" onclick="goDetail(' + obj.prodNo + ')">';
                contents += '               <figure class="block-4-image">';
                contents += '                    <img src="' + imgPath + '"  alt="Image placeholder"  class="img-fluid" style="width: 100%; height: 193.53px;">';
                contents += '                </figure>';
                contents += '                <div class="block-4-text">';
                contents += '                    <h3 class="ItemName"><a href="#" onclick="goDetail(' + obj.prodNo + ')">' + textLengthOverCut(obj.prodNm,11,'...') + '</a></h3>';
                contents += '                    <div class=priceContent>';
                contents += '                    <p class="text-primary font-weight-bold">' + obj.prodPrc + '</p>';
                contents += '                    <span>' + wday + '</span>';
                contents += '                    </div>';
                contents += '                </div>';
                contents += '            </a>';
                contents += '        </div>';
                contents += '    </div>';
                contents += '</div>';

                //그리드에 삽입
                container.append(contents)
            })

        }

    }

    //상세페이지
    function goDetail(prodNo) {
        location.href = '/product/detail?prodNo=' + prodNo;
    }


    if(searchParam('prodNm')) {
        getProdNmQueryList();
    }
    else if(searchParam('catNo')) {
        getCatQueryList();
    }

    $(document).ready(function () {
        getCategory();
    });


</script>

</body>
</html>